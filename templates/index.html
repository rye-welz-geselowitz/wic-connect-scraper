<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<style>
</style>
<script
src="https://code.jquery.com/jquery-3.7.1.min.js"
integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<body>
<div class="container">
    
    <div id="form-container" class="row">
        <h1>WIC Data Demo</h1>
        <form id="creds-form" class="col s12">
            <div class="row">
                <div class="input-field col s12">
                    <label for="username">Username:</label><br>
                    <input type="text" id="username" name="username" required><br>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <label for="password">Password</label><br>
                    <input type="password" id="password" name="password" required><br><br>
                </div>
            </div>

            <button class="btn waves-effect waves-light" type="submit" name="action">Submit
                <i class="material-icons right">send</i>
            </button>
        </form>
    </div>

    <div id="loading-container" style="display: none;" class="row">
        <div class="progress">
            <div class="indeterminate"></div>
        </div>
    </div>

    <div id="error-container" style="display: none;" class="row">
        <h2>Sorry, something went wrong!</h2>
    </div>

    <div id="results-container" style="display: none;" class="row">
        <h3>Current Benefits</h3>
        <i>Your current food package includes:</i>
        <ul id="current-benefits-list" class="collection"></ul>
        <h3>Top items</h3>
        <i>The WIC items you've redeemed most frequently are:</i>
        <ul id="top-items-list" class="collection"></ul>
    </div>
</div>

</body>

<script>
    let pollingIntervalId;
    let pollRounds = 0;
    const pollIntervalSeconds = 5;
    const totalPollRounds = 10; 


    const stopPolling = () => {
        clearInterval(pollingIntervalId);
    }


    $('#creds-form').submit(function(e){
        e.preventDefault();
        submitCreds()
    });

    function submitCreds(){
        $('#form-container').hide()
        $('#loading-container').show()
        

        postData = {
            'username': $('#username').val(),
            'password': $('#password').val()
        }
        $.ajax({
            url: '/scrape-attempt',
            type: 'post',
            data: JSON.stringify(postData),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: pollScrapedData,
            error: displayErrorFromResponse
        });
    }

    function pollScrapedData(res){
        pollingIntervalId = setInterval(function(){
            if (pollRounds < totalPollRounds){
                syncScrapedData(res.token, res.username);
                pollRounds +=1;
            } else{
                stopPolling()
                displayError('Something went wrong!');
            }
        }, pollIntervalSeconds * 1000)
    }

    function displayErrorFromResponse(res) {
        const message = `${res.status}: ${res.hasOwnProperty('responseJSON') ? res.responseJSON['error'] || res.responseText : res.statusText}`
        displayError(message);
    }

    function displayError(message){
        $('#loading-container').hide()
        $('#error-container').append(`<span>${message}</span>`)
        $('#error-container').show()       
    }

    function syncScrapedData(token, username){
        $.ajax({
            url: '/scrape-attempt',
            type: 'get',
            data: {'token': token, 'username': username},
            success: function(res){
                if(res.status === 'SUCCESS'){
                    currentBenefitsList = $('#current-benefits-list')
                    res.benefits.forEach((b)=>{
                        currentBenefitsList.append(`<li class="collection-item">${b.remaining} ${b.unit} ${b.name}</li>`)
                    });
                    topItemsList = $('#top-items-list')
                    res.transactions_summary.slice(0, 10).forEach((item)=>{
                        topItemsList.append(`<li class="collection-item"><b>${item.item}</b> (${item.quantity} ${item.unit})</li>`)
                    }) 
                    $('#loading-container').hide()
                    $('#results-container').show() 
                    stopPolling();
                    console.log('Stopping polling!')
                }
                if(res.status === 'FAILURE'){
                    displayError(`Something went wrong: ${res.error_category}`)
                    stopPolling();
                }
            },
            error: displayErrorFromResponse
        }); 
            
    }

</script>
</html>



